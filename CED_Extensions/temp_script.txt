# -*- coding: utf-8 -*-
"""
Add YAML Profiles
-----------------
Helper to append new type entries to CEDLib.lib/profileData.yaml (JSON format) used by
Place Elements (YAML).

Flow:
1) User picks a CAD CSV to get the available CAD profile names.
2) User picks a CAD profile name to attach the new type(s) to.
3) User selects one or more Revit elements (families or model groups).
4) User picks a target point (new insertion base) and a facing point.
   - Facing is snapped to the nearest of 8 cardinal directions in plan: N, NE, E, SE, S, SW, W, NW.
5) Offsets (x/y/z inches) are auto-computed from the element's current location to the target.
6) Captures: label (Family : Type), category, is_group flag, offsets, and CKT_* parameters
   (CKT_Rating_CED, CKT_Panel_CEDT, CKT_Schedule Notes_CEDT, CKT_Circuit Number_CEDT, CKT_Load Name_CEDT).
"""

import io
import json
import math
import os
import datetime
import csv
import codecs

from pyrevit import revit, forms

# Add CEDLib.lib to sys.path for shared assets
import sys

LIB_ROOT = os.path.abspath(
    os.path.join(os.path.dirname(__file__), "..", "..", "..", "..", "..", "CEDLib.lib")
)
if LIB_ROOT not in sys.path:
    sys.path.append(LIB_ROOT)

DATA_PATH = os.path.join(LIB_ROOT, "profileData.yaml")
LOG_PATH = os.path.join(LIB_ROOT, "profileData_add.log")

try:
    basestring
except NameError:
    basestring = str

from Autodesk.Revit.DB import Group, GroupType, ElementTransformUtils, Line, XYZ  # noqa: E402

# --------------------------------------------------------------------------- #
# Helpers
# --------------------------------------------------------------------------- #


def _load_profiles(path):
    if not os.path.exists(path):
        return {"profiles": []}
    with io.open(path, "r", encoding="utf-8") as f:
        return json.load(f)


def _save_profiles(path, data):
    with io.open(path, "w", encoding="utf-8") as f:
        json.dump(data, f, indent=2)


def _log_entry(entry):
    try:
        with io.open(LOG_PATH, "a", encoding="utf-8") as f:
            f.write(json.dumps(entry, ensure_ascii=True) + "\n")
    except Exception:
        pass


def _get_point(elem):
    loc = getattr(elem, "Location", None)
    if loc is None:
        return None
    if hasattr(loc, "Point") and loc.Point:
        return loc.Point
    if hasattr(loc, "Curve") and loc.Curve:
        try:
            return loc.Curve.Evaluate(0.5, True)
        except Exception:
            return None
    return None


def _feet_to_inches(value):
    try:
        return float(value) * 12.0
    except Exception:
        return 0.0


def _snap_to_cardinal(vec):
    """Snap XY vector to nearest 45-degree direction; return angle degrees."""
    ang = 0.0
    try:
        ang = math.degrees(math.atan2(vec.Y, vec.X))
    except Exception:
        ang = 0.0
    snapped = round(ang / 45.0) * 45.0
    return snapped % 360.0


def _collect_params(elem):
    targets = {
        "CKT_Rating_CED": ["CKT_Rating_CED"],
        "CKT_Panel_CEDT": ["CKT_Panel_CED", "CKT_Panel_CEDT"],
        "CKT_Schedule Notes_CEDT": ["CKT_Schedule Notes_CED", "CKT_Schedule Notes_CEDT"],
        "CKT_Circuit Number_CEDT": ["CKT_Circuit Number_CED", "CKT_Circuit Number_CEDT"],
        "CKT_Load Name_CEDT": ["CKT_Load Name_CED", "CKT_Load Name_CEDT"],
    }
    found = {k: "" for k in targets.keys()}
    for p in getattr(elem, "Parameters", []) or []:
        try:
            name = p.Definition.Name
        except Exception:
            continue
        target_key = None
        for out_key, aliases in targets.items():
            if name in aliases:
                target_key = out_key
                break
        if not target_key:
            continue
        try:
            st = p.StorageType.ToString()
        except Exception:
            st = ""
        try:
            if st == "String":
                found[target_key] = p.AsString() or ""
            elif st == "Double":
                found[target_key] = p.AsDouble()
            elif st == "Integer":
                found[target_key] = p.AsInteger()
            else:
                found[target_key] = p.AsValueString() or ""
        except Exception:
            continue
    return found


def _build_type_entry(elem, offset_vec, rot_deg):
    fam_name = None
    type_name = None
    is_group = False
    cat_name = None
    try:
        cat = elem.Category
        if cat:
            cat_name = cat.Name
    except Exception:
        pass

    if isinstance(elem, Group) or isinstance(elem, GroupType):
        is_group = True
        try:
            fam_name = elem.Name
            type_name = elem.Name
        except Exception:
            pass
    else:
        try:
            sym = getattr(elem, "Symbol", None) or getattr(elem, "GroupType", None)
            if sym:
                fam = getattr(sym, "Family", None)
                fam_name = getattr(fam, "Name", None) if fam else None
                type_name = getattr(sym, "Name", None)
        except Exception:
            pass

    label = None
    if fam_name and type_name:
        label = u"{} : {}".format(fam_name, type_name)
    elif type_name:
        label = type_name
    elif fam_name:
        label = fam_name
    else:
        label = "Unnamed"

    params = _collect_params(elem)

    type_entry = {
        "label": label,
        "is_group": is_group,
        "instance_config": {
            "offsets": [{
                "x_inches": _feet_to_inches(offset_vec.X),
                "y_inches": _feet_to_inches(offset_vec.Y),
                "z_inches": _feet_to_inches(offset_vec.Z),
                "rotation_deg": rot_deg,
            }],
            "parameters": params,
            "tags": [],
        },
        "category_name": cat_name or "",
    }
    return type_entry


# --------------------------------------------------------------------------- #
# Main
# --------------------------------------------------------------------------- #


def main():
    doc = revit.doc

    # 1) Pick CAD CSV and choose CAD profile name
    csv_path = forms.pick_file(file_ext="csv", title="Select CAD CSV (for CAD names)")
    if not csv_path:
        return
    cad_names = set()
    try:
        with codecs.open(csv_path, "r", encoding="utf-8-sig") as f:
            reader = csv.DictReader(f, delimiter=",")
            for row in reader:
                name = (row.get("Name") or "").strip()
                if name:
                    cad_names.add(name)
    except Exception as ex:
        forms.alert("Failed to read CSV:\n\n{}".format(ex), title="Add YAML Profiles")
        return

    if not cad_names:
        forms.alert("No CAD names found in CSV.", title="Add YAML Profiles")
        return

    cad_choice = forms.SelectFromList.show(sorted(cad_names), title="Select CAD profile name", multiselect=False)
    if not cad_choice:
        return
    cad_name = cad_choice if isinstance(cad_choice, basestring) else cad_choice[0]

    # 2) Pick elements
    try:
        elems = revit.pick_elements(message="Select Revit element(s) to create YAML profile type(s)")
    except Exception:
        # fallback single
        e = revit.pick_element(message="Select Revit element to create YAML profile type")
        elems = [e] if e else []
    if not elems:
        return

    # 3) Pick target base point and facing point (snapped to 8-cardinal)
    target_pt = revit.pick_point(message="Pick target point (new insertion base for offsets)")
    if not target_pt:
        return
    face_pt = revit.pick_point(message="Pick facing direction point (snaps to nearest 45Â°)")
    if not face_pt:
        return
    facing_vec = face_pt - target_pt
    rot_deg = _snap_to_cardinal(facing_vec)

    type_entries = []
    # Move elements to target and build entries
    for e in elems:
        base_pt = _get_point(e)
        if base_pt is None:
            continue
        offset_vec = target_pt - base_pt
        try:
            ElementTransformUtils.MoveElement(doc, e.Id, offset_vec)
        except Exception:
            pass
        try:
            if abs(rot_deg) > 1e-6:
                axis = Line.CreateBound(target_pt, target_pt + XYZ(0, 0, 1))
                ElementTransformUtils.RotateElement(doc, e.Id, axis, math.radians(rot_deg))
        except Exception:
            pass
        type_entries.append(_build_type_entry(e, offset_vec, rot_deg))

    if not type_entries:
        forms.alert("No valid locations found on selected elements.", title="Add YAML Profiles")
        return

    data = _load_profiles(DATA_PATH)
    profiles = data.get("profiles") or []

    prof = None
    for p in profiles:
        if p.get("cad_name") == cad_name:
            prof = p
            break
    if prof is None:
        prof = {"cad_name": cad_name, "types": []}
        profiles.append(prof)

    prof_types = prof.get("types") or []
    # de-duplicate by label: update if label exists, else append
    existing_by_label = {}
    for t in prof_types:
        lbl = (t.get("label") or "").strip()
        if lbl:
            existing_by_label[lbl] = t

    for entry in type_entries:
        lbl = (entry.get("label") or "").strip()
        if lbl and lbl in existing_by_label:
            # update offsets/params/is_group/category from new measurement
            existing_by_label[lbl].update(entry)
        else:
            prof_types.append(entry)

    prof["types"] = prof_types
    data["profiles"] = profiles

    try:
        _save_profiles(DATA_PATH, data)
        _log_entry({
            "timestamp": datetime.datetime.utcnow().isoformat() + "Z",
            "action": "add",
            "cad_name": cad_name,
            "type_labels": [t.get("label") for t in type_entries],
            "user": os.getenv("USERNAME") or os.getenv("USER") or "unknown",
        })
        forms.alert("Added {} type(s) under CAD profile '{}'.\nReload Place Elements (YAML) to use them.".format(len(type_entries), cad_name), title="Add YAML Profiles")
    except Exception as ex:
        forms.alert("Failed to save profileData.yaml:\n\n{}".format(ex), title="Add YAML Profiles")


if __name__ == "__main__":
    main()

